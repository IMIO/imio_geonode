postgis:
    build: Dockerfiles/postgis/
    hostname: postgis
    ports:
        - "5432:5432"
    volumes:
        - ./postgres_data:/var/lib/postgresql

rabbitmq:
    image: rabbitmq
    hostname: rabbitmq-server
    ports:
        - "5672:5672"
        - "15672:15672"

geoserver:
    build: Dockerfiles/geoserver/
    hostname: geoserver
    links:
        - postgis:postgis
    ports:
        - 8080:8080
    volumes:
        - ./geoserver_data:/opt/geoserver/data_dir

# NOTES:
#   - The C_FORCE_ROOT variable allows celery to run as the root user.
surveyworker:
    build: .
    environment:
        - C_FORCE_ROOT=true
    hostname: geonode-worker
    links:
        - postgis:postgis
        - rabbitmq
    volumes:
        - .:/opt/imio_geonode/
    entrypoint:
        - /usr/bin/python
    command: manage.py celery worker -E -lINFO

geonode:
    build: .
    environment:
        - C_FORCE_ROOT=true
    hostname: geonode
    links:
        - postgis:postgis
        - rabbitmq
    ports:
        - 8000:8000
    volumes:
        - .:/opt/imio_geonode/
    entrypoint:
        - /usr/bin/python
    command: manage.py runserver 0.0.0.0:8000

nginx:
    build: Dockerfiles/nginx/
    ports:
        - 80:80
    links:
        - geonode
        - geoserver
        - postgis
